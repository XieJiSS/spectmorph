#!/bin/bash

SMENC=@top_builddir@/src/smenc
SMPLAY=@top_builddir@/src/smplay
SMENCFLAGS="-O0 --no-attack"
WAV2ASCII=@top_builddir@/tools/wav2ascii
DELTA=@top_srcdir@/tools/delta.py

die()
{
  echo "$0: $@"
  exit 1
}

if test -f "@srcdir@/$1"; then
  WAV="@srcdir@/$1"
elif test -f "@top_builddir@/tests/$1"; then
  WAV="@top_builddir@/tests/$1"
else
  echo "$0: $1 not found"
  exit 1
fi
START="$2"
STOP="$3"
RATE="$4"
FREQ="$5"

test -z "$FREQ" && die "freq parameter missing"

SM=$(echo "$1" | sed s/.wav$/.sm/g)
DWAV=$(echo "$1" | sed s/.wav$/-dec.wav/g)
TWAV=$(echo "$1" | sed s/.wav$/.txt/g)
TDWAV=$(echo "$1" | sed s/.wav$/-dec.txt/g)
TDEBUGDEC=$(echo "$1" | sed s/.wav$/-debug-dec.txt/g)

$SMENC $SMENCFLAGS -f $FREQ $WAV $SM --debug-decode $TDEBUGDEC || die "smenc failed"
$SMPLAY $SM --no-noise --rate=$RATE --export $DWAV || die "smplay failed"
$WAV2ASCII $WAV > $TWAV
$WAV2ASCII $DWAV > $TDWAV
$DELTA $TWAV $TDEBUGDEC | LANG=C awk 'FNR > '$START' && FNR < '$STOP' { r += $1 * $1; c += 1 } END { print "'$1' residual value:",r/c; if (r/c > 4e-5) exit(1); else exit (0);}' || exit 1
$DELTA $TWAV $TDWAV | LANG=C awk 'FNR > '$START' && FNR < '$STOP' { r += $1 * $1; c += 1 } END { print "'$1' residual value (int16 quantization):",r/c; if (r/c > 4e-5) exit(1); else exit (0);}' || exit 1
rm $SM $TWAV $TDWAV $DWAV $TDEBUGDEC
